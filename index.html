<html w-tid="0">
<head w-tid="1"><style>html{min-height:100%}.ctxmenu{position:fixed;border:1px solid #999;padding:2px 0;box-shadow:#aaa 3px 3px 3px;background:#fff;margin:0;z-index:9999;overflow-y:auto;font:15px Verdana, sans-serif;box-sizing:border-box}.ctxmenu li{margin:1px 0;display:block;position:relative;user-select:none}.ctxmenu li.heading{font-weight:bold;margin-left:-5px}.ctxmenu li span{display:block;padding:2px 20px;cursor:default}.ctxmenu li a{color:inherit;text-decoration:none}.ctxmenu li.icon{padding-left:15px}.ctxmenu img.icon{position:absolute;width:18px;left:10px;top:2px}.ctxmenu li.disabled{color:#ccc}.ctxmenu li.divider{border-bottom:1px solid #aaa;margin:5px 0}.ctxmenu li.interactive:hover{background:rgba(0, 0, 0, .1)}.ctxmenu li.submenu::after{content:"";position:absolute;display:block;top:0;bottom:0;right:.4em;margin:auto .1rem auto auto;border-right:1px solid #000;border-top:1px solid #000;transform:rotate(45deg);width:.3rem;height:.3rem}.ctxmenu li.submenu.disabled::after{border-color:#ccc}</style><base href="" simulated-href="/" w-tid="2">
<link rel="stylesheet" href="/fonts.css?v=82df4af7f27fb5caa75cd95cfd2c2e060fa13f33">
<link rel="stylesheet" href="/ctxmenu.css?v=82df4af7f27fb5caa75cd95cfd2c2e060fa13f33">


<meta charset="UTF-8" w-tid="3"><meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" w-tid="4"><meta name="apple-mobile-web-app-capable" content="yes" w-tid="5"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" w-tid="6"><meta name="apple-mobile-web-app-title" content="Enhanced Li-Ai" w-tid="7"><meta name="theme-color" content="#1a1a2e" w-tid="8"><link rel="icon" href="https://i.imgur.com/5eikbcV.png" type="image/png" w-tid="9"><title w-tid="10">Enhanced Li-Ai</title><style w-tid="11">
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Open+Sans:wght@400;600&display=swap');

:root {
  --primary-color: #6a11cb;
  --secondary-color: #2575fc;
  --text-color: #ffffff;
  --background-color: #1a1a2e;
  --chat-background: rgba(255, 255, 255, 0.05);
  --user-message-color: #4ecdc4;
  --bot-message-color: #45aaf2;
  --input-background: rgba(255, 255, 255, 0.1);
  --button-color: #ff6b6b;
  --button-hover-color: #ff8787;
}

.light-theme {
  --primary-color: #3498db;
  --secondary-color: #2ecc71;
  --text-color: #2c3e50;
  --background-color: #ecf0f1;
  --chat-background: rgba(52, 152, 219, 0.1);
  --user-message-color: #3498db;
  --bot-message-color: #2ecc71;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Open Sans', sans-serif;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: var(--text-color);
  min-height: 100vh;
  margin: 0;
  display: flex;
  flex-direction: column;
}

.chat-container {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  max-width: 800px;
  margin: 0 auto;
  background-color: var(--background-color);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  overflow: hidden;
}

.chat-header {
  background-color: var(--chat-background);
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-title {
  font-family: 'Montserrat', sans-serif;
  font-size: 1.4em;
  font-weight: 600;
}

.header-buttons {
  display: flex;
  gap: 10px;
}

.header-button {
  background: none;
  border: none;
  color: var(--text-color);
  cursor: pointer;
  padding: 5px;
  transition: color 0.3s ease;
}

.header-button:hover {
  color: var(--button-hover-color);
}

.chat-messages {
  flex-grow: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
}

.message {
  max-width: 80%;
  margin-bottom: 15px;
  padding: 12px 16px;
  border-radius: 20px;
  animation: fadeIn 0.5s;
  word-wrap: break-word;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.user-message {
  background-color: var(--user-message-color);
  color: var(--background-color);
  align-self: flex-end;
  border-bottom-right-radius: 5px;
}

.bot-message {
  background-color: var(--bot-message-color);
  color: var(--text-color);
  align-self: flex-start;
  border-bottom-left-radius: 5px;
}

.chat-input {
  display: flex;
  padding: 20px;
  background-color: var(--chat-background);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

#user-input {
  flex-grow: 1;
  padding: 12px 20px;
  border: none;
  border-radius: 25px;
  background-color: var(--input-background);
  color: var(--text-color);
  font-size: 16px;
  transition: all 0.3s ease;
}

#user-input:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
}

.input-button {
  width: 50px;
  height: 50px;
  margin-left: 10px;
  border: none;
  border-radius: 50%;
  background-color: var(--button-color);
  color: var(--text-color);
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  justify-content: center;
  align-items: center;
}

.input-button:hover {
  background-color: var(--button-hover-color);
  transform: scale(1.05);
}

.input-button:active {
  transform: scale(0.95);
}

#image-upload {
  display: none;
}

.loading {
  align-self: flex-start;
  margin-bottom: 15px;
}

.loading-dots {
  display: flex;
  justify-content: center;
  align-items: center;
  background-color: rgba(69, 170, 242, 0.3);
  border-radius: 20px;
  padding: 10px 15px;
}

.loading-dot {
  width: 8px;
  height: 8px;
  background-color: var(--text-color);
  border-radius: 50%;
  margin: 0 3px;
  animation: bounce 1.4s infinite ease-in-out both;
}

.loading-dot:nth-child(1) { animation-delay: -0.32s; }
.loading-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}

::-webkit-scrollbar {
  width: 6px;
}

::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.3);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.5);
}

.uploaded-image {
  max-width: 100%;
  border-radius: 10px;
  margin-top: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

#image-preview {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  object-fit: cover;
  display: none;
  margin-left: 10px;
  border: 2px solid var(--text-color);
}

pre {
  background-color: rgba(0, 0, 0, 0.1);
  padding: 10px;
  border-radius: 5px;
  overflow-x: auto;
}

code {
  font-family: 'Courier New', Courier, monospace;
  font-size: 0.9em;
}

.safe-area-top, .safe-area-bottom {
  background-color: var(--background-color);
}

.safe-area-top {
  height: env(safe-area-inset-top);
}

.safe-area-bottom {
  height: env(safe-area-inset-bottom);
}

#theme-toggle {
  font-size: 20px;
  background: none;
  border: none;
  cursor: pointer;
}

.dark-theme {
  --primary-color: #2c3e50;
  --secondary-color: #34495e;
  --text-color: #ecf0f1;
  --background-color: #1a1a2e;
  --chat-background: rgba(52, 73, 94, 0.1);
  --user-message-color: #3498db;
  --bot-message-color: #2ecc71;
}

@media (max-width: 480px) {
  .chat-container {
    height: 100vh;
  }

  .chat-messages {
    height: calc(100vh - 140px);
  }
}

.voice-input-button {
  background-color: var(--button-color);
  color: var(--text-color);
  border: none;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  margin-left: 10px;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: all 0.3s ease;
}

.voice-input-button:hover {
  background-color: var(--button-hover-color);
  transform: scale(1.05);
}

.voice-input-button:active {
  transform: scale(0.95);
}

.voice-input-active {
  animation: pulse 1s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.tooltip {
  position: relative;
  display: inline-block;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 120px;
  background-color: var(--chat-background);
  color: var(--text-color);
  text-align: center;
  border-radius: 6px;
  padding: 5px;
  position: absolute;
  z-index: 1;
  bottom: 125%;
  left: 50%;
  margin-left: -60px;
  opacity: 0;
  transition: opacity 0.3s;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}

</style></head><body w-tid="12" class="dark">
<div class="safe-area-top" w-tid="13"></div>
<div class="chat-container" w-tid="14">
  <div class="chat-header" w-tid="15">
    <div class="chat-title" w-tid="16">Enhanced Li-Ai</div>
    <div class="header-buttons" w-tid="17">
      <button class="header-button tooltip" id="change-prompt-button" title="Change System Prompt" w-tid="18">
        <span class="tooltiptext" w-tid="19">Change System Prompt</span>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" w-tid="20">
          <path d="M12 15.5C13.933 15.5 15.5 13.933 15.5 12C15.5 10.067 13.933 8.5 12 8.5C10.067 8.5 8.5 10.067 8.5 12C8.5 13.933 10.067 15.5 12 15.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" w-tid="21"></path>
          <path d="M19.4 15A1.65 1.65 0 0 0 20 12.5V11.5A1.65 1.65 0 0 0 19.4 9M4.6 9A1.65 1.65 0 0 1 4 11.5V12.5A1.65 1.65 0 0 1 4.6 15M12 8V6M12 18V16M16.24 7.76L17.66 6.34M6.34 17.66L7.76 16.24M16.24 16.24L17.66 17.66M6.34 6.34L7.76 7.76" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" w-tid="22"></path>
        </svg>
      </button>
      <button class="header-button tooltip" id="restart-button" title="Restart Conversation" w-tid="23">
        <span class="tooltiptext" w-tid="24">Restart Conversation</span>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" w-tid="25">
          <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" w-tid="26"></path>
          <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" w-tid="27"></path>
          <path d="M10 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" w-tid="28"></path>
          <path d="M14 11V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" w-tid="29"></path>
        </svg>
      </button>
      <button id="theme-toggle" class="tooltip" w-tid="30">
        <span class="tooltiptext" w-tid="31">Toggle Theme</span>
        ðŸŒ“
      </button>
    </div>
  </div>
  <div class="chat-messages" id="chat-messages" role="log" aria-live="polite" w-tid="32">
    <!-- Messages will appear here -->
  <div class="message bot-message"><div>Welcome back! You can continue your conversation.</div></div></div>
  <div class="chat-input" w-tid="33">
    <input type="text" id="user-input" placeholder="Type your message..." aria-label="Type your message" w-tid="34">
    <button class="input-button tooltip" id="image-button" title="Upload Image" w-tid="35">
      <span class="tooltiptext" w-tid="36">Upload Image</span>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" w-tid="37">
        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="currentColor" w-tid="38"></path>
      </svg>
    </button>
    <input type="file" id="image-upload" accept="image/*" w-tid="39">
    <img id="image-preview" src="#" alt="Image preview" data-image_id="0" w-tid="40" class="websim-loading">
    <button class="voice-input-button tooltip" id="voice-input-button" title="Voice Input" w-tid="41">
      <span class="tooltiptext" w-tid="42">Voice Input</span>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" w-tid="43">
        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" fill="currentColor" w-tid="44"></path>
        <path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" w-tid="45"></path>
      </svg>
    </button>
    <button class="input-button tooltip" id="send-button" title="Send Message" aria-label="Send Message" w-tid="46">
      <span class="tooltiptext" w-tid="47">Send Message</span>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" w-tid="48">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="currentColor" w-tid="49"></path>
      </svg>
    </button>
  </div>
</div>
<div class="safe-area-bottom" w-tid="50"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" w-tid="51"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" w-tid="52"></script>

<script w-tid="53">
const API_URL = "https://openrouter.ai/api/v1/chat/completions";
const ENCRYPTED_API_KEY = "U2FsdGVkX19yvWTKX7phTb187mjVYLIATMuj/vPJ3kJ0lx52lMA4ugj9QwfBprbd5kjxSUnI+v6UaWD4gV5MUh7w2u+Kw6JOG+4gwV05rDWd5/19rJa9FYa/wHBoENkh";

const chatMessages = document.getElementById('chat-messages');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const imageButton = document.getElementById('image-button');
const imageUpload = document.getElementById('image-upload');
const imagePreview = document.getElementById('image-preview');
const restartButton = document.getElementById('restart-button');
const changePromptButton = document.getElementById('change-prompt-button');
const themeToggle = document.getElementById('theme-toggle');
const voiceInputButton = document.getElementById('voice-input-button');

let uploadedImageBase64 = null;
let conversationHistory = [];
let isPasswordEntered = false;
let decryptedApiKey = '';
let systemPrompt = "You are an AI assistant with a wide range of knowledge. You can engage in conversations, answer questions, and provide assistance on various topics. Please respond concisely unless detailed explanations are necessary.";
let recognition;
let isRecording = false;

window.onload = () => {
  const storedApiKey = localStorage.getItem('decryptedApiKey');
  const storedSystemPrompt = localStorage.getItem('systemPrompt');
  const storedTheme = localStorage.getItem('theme');
  
  if (storedApiKey) {
    decryptedApiKey = storedApiKey;
    isPasswordEntered = true;
    if (storedSystemPrompt) {
      systemPrompt = storedSystemPrompt;
    }
    addMessage('Welcome back! You can continue your conversation.');
    const systemMsg = { role: "system", content: systemPrompt };
    conversationHistory.push(systemMsg);
  } else {
    addMessage('Please enter the password to start the conversation.');
  }

  if (storedTheme) {
    document.body.className = storedTheme;
  }
};

function escapeHtml(unsafe) {
  return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function addMessage(content, isUser = false, imageUrl = null) {
  const messageElement = document.createElement('div');
  messageElement.classList.add('message');
  messageElement.classList.add(isUser ? 'user-message' : 'bot-message');

  if (content) {
    const textNode = document.createElement('div');
    textNode.innerHTML = convertMarkdownToHtml(content);
    messageElement.appendChild(textNode);
  }

  if (imageUrl) {
    const imageNode = document.createElement('img');
    imageNode.src = imageUrl;
    imageNode.alt = 'Uploaded Image';
    imageNode.classList.add('uploaded-image');
    messageElement.appendChild(imageNode);
  }

  chatMessages.appendChild(messageElement);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  if (isUser) {
    conversationHistory.push({
      role: "user",
      content: content,
      imageUrl: imageUrl
    });
  }
}

function convertMarkdownToHtml(text) {
  text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, language, code) => {
    return `<pre><code class="language-${language || ''}">${escapeHtml(code.trim())}</code></pre>`;
  });
  text = text.replace(/^###\s(.+)$/gm, '<h3>$1</h3>');
  text = text.replace(/^##\s(.+)$/gm, '<h2>$1</h2>');
  text = text.replace(/^#\s(.+)$/gm, '<h1>$1</h1>');
  text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
  text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
  text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
  text = text.replace(/\n/g, '<br>');
  return text;
}

function addLoadingIndicator() {
  const loadingElement = document.createElement('div');
  loadingElement.classList.add('loading');
  loadingElement.innerHTML = `
    <div class="loading-dots">
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>
  `;
  chatMessages.appendChild(loadingElement);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  return loadingElement;
}

function resetImageInput() {
  uploadedImageBase64 = null;
  imagePreview.style.display = 'none';
  imagePreview.src = '#';
  imageButton.style.display = 'flex';
  imageUpload.value = '';
}

function handleImageUpload(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      uploadedImageBase64 = e.target.result;
      imagePreview.src = uploadedImageBase64;
      imagePreview.style.display = 'block';
      imageButton.style.display = 'none';
    };
    reader.readAsDataURL(file);
  }
}

async function sendMessage() {
  const message = userInput.value.trim();
  if (message || uploadedImageBase64) {
    if (!isPasswordEntered) {
      checkPassword(message);
    } else {
      if (uploadedImageBase64 && !message) {
        alert('Please write a message along with the image.');
        return;
      }
      if (message.length > 500) {
        alert('Message is too long. Please limit your message to 500 characters.');
        return;
      }
      addMessage(message, true, uploadedImageBase64);
      userInput.value = '';

      const loadingIndicator = addLoadingIndicator();

      try {
        const messages = conversationHistory.map(msg => ({
          role: msg.role,
          content: msg.content
        }));

        const content = [{ type: "text", text: message }];
        if (uploadedImageBase64) {
          content.push({
            type: "image_url",
            image_url: {
              url: uploadedImageBase64,
              detail: "low"
            }
          });
        }

        messages.push({ role: "user", content });

        const payload = {
          stream: true,
          model: "mistralai/pixtral-12b:free",
          messages: messages,
          transforms: ["middle-out"],
          max_tokens: 0
        };

        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${decryptedApiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        loadingIndicator.remove();
        await handleStreamingResponse(response);
      } catch (error) {
        console.error('Error:', error);
        loadingIndicator.remove();
        addMessage('Sorry, I encountered an error. Please try again later.');
      }

      resetImageInput();
    }
  }
}

async function handleStreamingResponse(response) {
  const reader = response.body.getReader();
  const decoder = new TextDecoder();
  let botReply = '';
  const botMessageElement = document.createElement('div');
  botMessageElement.classList.add('message', 'bot-message');
  chatMessages.appendChild(botMessageElement);

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;

    const chunk = decoder.decode(value);
    const lines = chunk.split('\n');
    for (const line of lines) {
      if (line.startsWith('data: ')) {
        try {
          const jsonData = JSON.parse(line.slice(6));
          if (jsonData.choices && jsonData.choices[0].delta && jsonData.choices[0].delta.content) {
            botReply += jsonData.choices[0].delta.content;
            botMessageElement.innerHTML = convertMarkdownToHtml(botReply);
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        } catch (error) {
          console.error('Error parsing JSON:', error);
        }
      }
    }
  }

  conversationHistory.push({
    role: "assistant",
    content: botReply
  });
}

function restartConversation() {
  conversationHistory = [];
  chatMessages.innerHTML = '';
  addMessage('Conversation has been restarted.');
  if (isPasswordEntered) {
    addMessage('You can continue your conversation.');
    const systemMsg = { role: "system", content: systemPrompt };
    conversationHistory.push(systemMsg);
  } else {
    addMessage('Please enter the password to start the conversation.');
  }
}

function checkPassword(password) {
  try {
    const decrypted = CryptoJS.AES.decrypt(ENCRYPTED_API_KEY, password).toString(CryptoJS.enc.Utf8);

    if (decrypted.startsWith("sk-or-v1-")) {
      isPasswordEntered = true;
      decryptedApiKey = decrypted;
      localStorage.setItem('decryptedApiKey', decryptedApiKey);
      addMessage('Password correct. You can now start the conversation.');
      const systemMsg = { role: "system", content: systemPrompt };
      conversationHistory.push(systemMsg);
    } else {
      addMessage('Incorrect password. Please try again.');
    }
  } catch (error) {
    addMessage('Incorrect password or decryption failed. Please try again.');
  }

  userInput.value = '';
}

function changeSystemPrompt() {
  const newPrompt = prompt("Enter the new system prompt:", systemPrompt);
  if (newPrompt !== null && newPrompt.trim() !== "") {
    systemPrompt = newPrompt.trim();
    localStorage.setItem('systemPrompt', systemPrompt);
    const systemIndex = conversationHistory.findIndex(msg => msg.role === "system");
    if (systemIndex !== -1) {
      conversationHistory[systemIndex].content = systemPrompt;
    } else {
      conversationHistory.push({ role: "system", content: systemPrompt });
    }
    addMessage('System prompt has been updated.');
  }
}

function toggleTheme() {
  document.body.classList.toggle('light-theme');
  localStorage.setItem('theme', document.body.classList.contains('light-theme') ? 'light' : 'dark');
}

const storedTheme = localStorage.getItem('theme');
if (storedTheme === 'light') {
  document.body.classList.add('light-theme');
}

themeToggle.addEventListener('click', toggleTheme);

function startVoiceInput() {
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US'; // Set language to English

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      userInput.value = transcript;
      sendMessage(); // Automatically send the message
      userInput.value = ''; // Clear the input field
    };

    recognition.onerror = function(event) {
      console.error('Speech recognition error', event.error);
    };
    
    recognition.start();
    isRecording = true;
    voiceInputButton.classList.add('voice-input-active');
  } else {
    alert('Speech recognition is not supported in your browser.');
  }
}

function stopVoiceInput() {
  if (recognition) {
    recognition.stop();
    isRecording = false;
    voiceInputButton.classList.remove('voice-input-active');
    // Remove the sendMessage() call from here as it's now in the onresult event
  }
}

voiceInputButton.addEventListener('mousedown', startVoiceInput);
voiceInputButton.addEventListener('touchstart', startVoiceInput);
voiceInputButton.addEventListener('mouseup', stopVoiceInput);
voiceInputButton.addEventListener('touchend', stopVoiceInput);
</script>
</body>
</html>
